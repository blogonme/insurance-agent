# 咖啡 ERP 系统全面审计报告 v1.0

## 1. 审计概述

- **审计日期**: 2026-01-07
- **整体评分**: 65/100
- **核心结论**:
  - 系统已具备完整的 ERP 业务链路，但在多租户架构切换过程中存在严重的约束一致性风险。
  - 前端代码膨胀严重，类型安全欠缺。
  - 缺乏单元测试覆盖。

## 2. 评分维度说明

| 维度       | 分数 | 状态    | 备注                                               |
| :--------- | :--- | :------ | :------------------------------------------------- |
| 后端架构   | 75   | 🟡 WARN | 分层基本清晰，但存在部分 Controller/Service 不对等 |
| 数据库设计 | 60   | 🔴 FAIL | 全局唯一约束(username)严重干扰多租户逻辑           |
| 前端架构   | 55   | 🔴 FAIL | 组件臃肿，any 类型泛滥                             |
| 安全性     | 75   | 🟡 WARN | 具备 JWT 和租户过滤逻辑，但多租户隔离约束不成熟    |
| 代码质量   | 65   | 🟡 WARN | TODO 较多，缺乏规范化命名检查                      |
| 运维测试   | 40   | 🔴 FAIL | 无测试用例，生产环境配置不全                       |

## 3. 关键发现

### 3.1 致命风险 (Critical)

1. **多租户数据冲突**: `users` 表的 `username` 字段为全局 `UNIQUE`。这意味着账套 A 创建了 `admin` 用户后，账套 B 无法创建同名用户，这违背了“账套/用户”的多租户隔离原则。
2. **测试缺失**: 项目中完全没有 `src/test` 目录，缺乏基本的质量保证。
3. **前端性能风险**: 多个核心业务页面（采购、销售、生产）体积超过 100KB，可能导致严重的加载和渲染性能问题。

### 3.2 主要缺陷 (Major)

1. **类型安全漏洞**: 前端代码中存在超过 200 处 `any` 类型声明。
2. **字段冗余与不一致**: 数据库和 Entity 中大量混用 `org_id` 和 `ledger_set_id`。
3. **API 模块不对等**: Controller 数量(33)显著多于 Service(28)，部分逻辑可能沉淀在 Controller 中。

## 4. 改进建议

1. **P0**: 立即修改 `users` 表约束，将 `username` 的唯一键改为 `(ledger_set_id, username)`。
2. **P0**: 启动核心业务逻辑的单元测试编写（尤其是库存扣减和凭证生成）。
3. **P1**: 拆分超大组件（`PurchaseOrders.tsx`, `SalesOrders.tsx`），提取通用的 Hook 和组件。
4. **P1**: 清理 `org_id` 字段，统一迁移至 `ledger_set_id` 进行多租户隔离。
5. **P2**: 推进前端 TypeScript 类型补全，消除 `any`。
